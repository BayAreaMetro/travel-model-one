---
title: "Core Summaries"
author: "Lisa Zorn"
date: "Friday, August 01, 2014"
output:
  html_document:
    css: custom.css
    toc: yes
# runtime: shiny
---

# Initialization: Set the workspace and load needed libraries
```{r Initialization, results="hold", error=TRUE}
library(knitr)
library(ggplot2)
library(scales)
library(xtable)
library(dplyr)
library(reshape2)

# For RStudio, these can be set in the .Rprofile
TARGET_DIR   <- Sys.getenv("TARGET_DIR")  # The location of the input files
POPSYN_HH    <- Sys.getenv("POPSYN_HH")   # The synthesized households file
POPSYN_PERS  <- Sys.getenv("POPSYN_PERS") # The synthesized persons file
ITER         <- Sys.getenv("ITER")        # The iteration of model outputs to read

TARGET_DIR   <- gsub("\\\\","/",TARGET_DIR) # switch slashes around

# run test mode?  It's a short version
TEST        <- FALSE
if (TEST) {
  TARGET_DIR  <- "C:/Users/lzorn/Documents/2020_03_116"
  POPSYN_HH   <- "hhFile.p2011s6g.2020"
  POPSYN_PERS <- "personFile.p2011s6g.2020"
  ITER        <- "1"
}

stopifnot(nchar(TARGET_DIR  )>0)
stopifnot(nchar(POPSYN_HH   )>0)
stopifnot(nchar(POPSYN_PERS )>0)
stopifnot(nchar(ITER        )>0)

# write results in TARGET_DIR/summary
if (!file.exists(file.path(TARGET_DIR,"summary"))) {
  dir.create(file.path(TARGET_DIR,"summary"))
}

cat("TARGET_DIR  = ",TARGET_DIR)
cat("POPSYN_HH   = ",POPSYN_HH)
cat("POPSYN_PERS = ",POPSYN_PERS)
cat("ITER        = ",ITER)
```
# Land Use

The land use file: http://analytics.mtc.ca.gov/foswiki/Main/TazData
```{r readLandUse}

tazData              <- read.table(file=file.path(TARGET_DIR,"tazData.csv"), header=TRUE, sep=",")
COUNTY_LABELS        <- c("San\nFrancisco","San\nMateo","Santa\nClara","Alameda",
                          "Contra\nCosta","Solano","Napa","Sonoma","Marin")
tazData              <- select(tazData, ZONE, SD, COUNTY, PRKCST)
names(tazData)[names(tazData)=="ZONE"] <- "taz"

```

# Household files

## Read the household files and land use file

There are two household files:

 * the model input file from the synthesized household/population (http://analytics.mtc.ca.gov/foswiki/Main/PopSynHousehold)
 * the model output file (http://analytics.mtc.ca.gov/foswiki/Main/Household)

```{r ReadHouseholds}
input.pop.households <- read.table(file = file.path(TARGET_DIR,paste0(POPSYN_HH,".csv")), 
                                   header=TRUE, sep=",")
input.ct.households  <- read.table(file = file.path(TARGET_DIR,paste0("householdData_",ITER,".csv")), 
                                   header=TRUE, sep = ",")
WALK_SUBZONE_LABELS  <- c("Cannot walk to transit (more than two-thirds of a mile away)",
                          "Short-walk to transit (less than one-third of a mile)",
                          "Long-walk to transit (between one-third and two-thirds of a mile)")
```

## Join them

Rename/drop some columns and join them on household id. Also join with tazData to get the super district and county.

```{r JoinHouseholds}
input.pop.households <- select(input.pop.households, HHID, PERSONS, hworkers, huniv, hpresch, 
                               hschpred, hschdriv)
input.ct.households  <- select(input.ct.households, -jtf_choice)

# rename
names(input.pop.households)[names(input.pop.households)=="HHID"] <- "hh_id"

households <- inner_join(input.pop.households, input.ct.households, "hh_id")
households <- inner_join(households, tazData, "taz")
# wrap as a d data frame tbl so it's nicer for printing
households <- tbl_df(households)
# clean up
remove(input.pop.households, input.ct.households)
```


## Recode a few new variables:
Create income quartiles (incQ), worker categories (workers), and dummy for households with children that don't drive (kidsNoDr).
```{r RecodeHouseholdVars}
# incQ are Income Quartiles
households    <- mutate(households, incQ=1*(income<30000) + 
                                         2*((income>=30000)&(income<60000)) +
                                         3*((income>=60000)&(income<100000)) +
                                         4*(income>=100000))

# workers are hworkers capped at 4
households    <- mutate(households, workers=4*(hworkers>=4) + hworkers*(hworkers<4))
WORKER_LABELS <- c("Zero", "One", "Two", "Three", "Four or more")

# kidsNoDr is 1 if the household has children in the househole that don't drive
# (either pre-school age or school age)
households    <- mutate(households, kidsNoDr=(hpresch>=1)|(hschpred>=1))
```

# Person files

There are two person files:

 * the model input file from the synthesized household/population (http://analytics.mtc.ca.gov/foswiki/Main/PopSynPerson)
 * the model output file (http://analytics.mtc.ca.gov/foswiki/Main/Person)

## Read the person files
```{r ReadPersons}
input.pop.persons    <- read.table(file = file.path(TARGET_DIR,paste0(POPSYN_PERS,".csv")), 
                                   header=TRUE, sep=",")
input.ct.persons     <- read.table(file = file.path(TARGET_DIR,paste0("personData_",ITER,".csv")),
                                   header=TRUE, sep = ",")
```

## Join them
```{r JoinPersons}
PTYPE_LABELS         <- c("Full-time worker","Part-time worker","College student","Non-working adult","Retired",
                          "Driving-age student","Non-driving-age student","Child too young for school")

# Rename
names(input.pop.persons)[names(input.pop.persons)=="HHID"] <- "hh_id"
names(input.pop.persons)[names(input.pop.persons)=="PERID"] <- "person_id"

# Inner join so persons must be present in both.  So only simulated persons stay.
persons              <- inner_join(input.pop.persons, input.ct.persons, by=c("hh_id", "person_id"))
# Get incQ from Households
persons              <- left_join(persons, select(households, hh_id, incQ), by=c("hh_id"))

# wrap as a d data frame tbl so it's nicer for printing
persons              <- tbl_df(persons)
# clean up
remove(input.pop.persons, input.ct.persons)
```

# Tours

## Read Individual Tours

The fields are documented here: http://analytics.mtc.ca.gov/foswiki/Main/IndividualTour

```{r readIndividualTours}
indiv_tours     <- read.table(file=file.path(TARGET_DIR,paste0("indivTourData_",ITER,".csv")), 
                              header=TRUE, sep=",")
indiv_tours     <- tbl_df(indiv_tours)

# add income from household table
indiv_tours     <- left_join(indiv_tours, select(households, hh_id, incQ), by=c("hh_id"))
```

## Function to add Cost to Tours
```{r Tours_AddCostColumn}
TIMECODE_LABELS <- c("EA","AM","MD","PM","EV")
TIMECODE_VALUES <- c(1,2,3,4,5)

# function add_cost: attaches the cost skims of the given time period (from TIMECODE_VALUES)
# to the given tours data.frame (joining on the columns orig_taz, dest_taz, and timeCode).
# Fills in values to the column 'cost' for the given time period based on the column 'costMode'.
# Pass reverse_od as TRUE to do return trip; this uses the dest taz as the origin and the origin
# taz as the dest, and it uses wTrnD cost rather than dTrnW.
# Tallies failed costs (expected cost but -999 found) in the field cost_fail
add_cost <- function(timeCode_val, tours, reverse_od=FALSE) {
  
  costSkims   <- read.table(file = file.path(TARGET_DIR,paste0("CostSkimsDatabase",
                                                               TIMECODE_LABELS[timeCode_val],".csv")), 
                            header=TRUE, sep=",")
  # rename columns for join -- reversing if needed (return trip)
  if (reverse_od) {
    names(costSkims)[names(costSkims)=="orig"] <- "dest_taz"  
    names(costSkims)[names(costSkims)=="dest"] <- "orig_taz"    
  } else {
    names(costSkims)[names(costSkims)=="orig"] <- "orig_taz"  
    names(costSkims)[names(costSkims)=="dest"] <- "dest_taz"
  }
  # don't recode -999 as 0 -- we'll deal with it after join
  costSkims   <- mutate(costSkims,
                        timeCode = timeCode_val)
  
  # Left join tours to the skims
  tours <- left_join(tours, costSkims, by=c("orig_taz","dest_taz","timeCode"))
  # assign active value if we can to new column active2
  tours <- mutate(tours,
                  cost2=((timeCode==timeCode_val)*(costMode==1)*da    ) +
                        ((timeCode==timeCode_val)*(costMode==2)*daToll) +
                        ((timeCode==timeCode_val)*(costMode==3)*s2    ) +
                        ((timeCode==timeCode_val)*(costMode==4)*s2Toll) +
                        ((timeCode==timeCode_val)*(costMode==5)*s3    ) +
                        ((timeCode==timeCode_val)*(costMode==6)*s3Toll) +
                        ((timeCode==timeCode_val)*(costMode==7)*0.0   ) +
                        ((timeCode==timeCode_val)*(costMode==8)*0.0   ) +
                        ((timeCode==timeCode_val)*(costMode==9)*wTrnW ) +
                        ((timeCode==timeCode_val)*(costMode==10)*(1-reverse_od)*dTrnW) +
                        ((timeCode==timeCode_val)*(costMode==10)*(reverse_od   *wTrnD))
                  )

  tours <- mutate(tours,
                  cost_fail2 = ifelse(cost2==-999,1,0),    # tally the cost_fail
                  cost2      = ifelse(cost2==-999,0,cost2) # reset the -999 to zero
                  )
      
  print(paste("For", TIMECODE_LABELS[timeCode_val], "assigned", prettyNum(sum(!is.na(tours$cost2)),big.mark=","),
              "costs, with", prettyNum(sum(!is.na(tours$cost2)&(tours$cost2>0)),big.mark=","),
              "nonzero values"))
  tours$cost2[is.na(tours$cost2)]           <- 0           # make the unassigned ones 0 for summing
  tours$cost_fail2[is.na(tours$cost_fail2)] <- 0           # make the unassigned ones 0 for summing
  tours <- mutate(tours, cost=cost+cost2,        # sum
                         cost_fail=cost_fail+cost_fail2)
  print(paste("  -> total nonzero costs:",prettyNum(sum(tours$cost!=0),big.mark=",")))
  tours <- select(tours, -da, -daToll, -s2, -s2Toll, -s3, -s3Toll, -wTrnW, -dTrnW, -wTrnD, -cost2, -cost_fail2) # rid new variables
}
```

## Function to add Distance to Tours
```{r Tours_AddDistanceColumn}

TIMECODE_LABELS <- c("EA","AM","MD","PM","EV")
TIMECODE_VALUES <- c(1,2,3,4,5)

# function add_distance: attaches the distance skims of the given time period (from TIMECODE_VALUES)
# to the given tours data.frame (joining on the columns orig_taz, dest_taz, and timeCode).
# Fills in values to the column 'distance' for the given time period based on the column 'tour_mode'.
add_distance <- function(timeCode_val, tours) {
  
  distSkims   <- read.table(file = file.path(TARGET_DIR,paste0("DistanceSkimsDatabase",
                                                               TIMECODE_LABELS[timeCode_val],".csv")), 
                            header=TRUE, sep=",")
  # rename columns for join -- reversing if needed (return trip)
  names(distSkims)[names(distSkims)=="orig"] <- "orig_taz"  
  names(distSkims)[names(distSkims)=="dest"] <- "dest_taz"
  
  distSkims   <- mutate(distSkims,
                        timeCode = timeCode_val,
                        da       = ifelse(da    == -999,0,da    ),
                        daToll   = ifelse(daToll== -999,0,daToll),
                        s2       = ifelse(s2    == -999,0,s2    ),
                        s2Toll   = ifelse(s2Toll== -999,0,s2Toll),
                        s3       = ifelse(s3    == -999,0,s3    ),
                        s3Toll   = ifelse(s3Toll== -999,0,s3Toll),
                        walk     = ifelse(walk  == -999,0,walk  ),
                        bike     = ifelse(bike  == -999,0,bike ))
  
  # Left join tours to the skims
  tours <- left_join(tours, distSkims, by=c("orig_taz","dest_taz","timeCode"))
  # assign active value if we can to new column active2
  tours <- mutate(tours,
                  distance2=((timeCode==timeCode_val)*(tour_mode==1)*da    ) +
                            ((timeCode==timeCode_val)*(tour_mode==2)*daToll) +
                            ((timeCode==timeCode_val)*(tour_mode==3)*s2    ) +
                            ((timeCode==timeCode_val)*(tour_mode==4)*s2Toll) +
                            ((timeCode==timeCode_val)*(tour_mode==5)*s3    ) +
                            ((timeCode==timeCode_val)*(tour_mode==6)*s3Toll) +
                            ((timeCode==timeCode_val)*(tour_mode==7)*walk  ) +
                            ((timeCode==timeCode_val)*(tour_mode==8)*bike  ) +
                            # Use the drive alone time as the distance for transit modes
                            ((timeCode==timeCode_val)*(tour_mode>=9)*da    )
                  )
  
  print(paste("For", TIMECODE_LABELS[timeCode_val], "assigned", prettyNum(sum(!is.na(tours$distance2)),big.mark=","),
              "distances, with", prettyNum(sum(!is.na(tours$distance2)&(tours$distance2>0)),big.mark=","),
              "nonzero values"))
  tours$distance2[is.na(tours$distance2)] <- 0         # make the unassigned ones 0 for summing
  tours <- mutate(tours, distance=distance+distance2)  # sum
  print(paste("  -> total nonzero distances:",prettyNum(sum(tours$distance!=0),big.mark=",")))
  tours <- select(tours, -da, -daToll, -s2, -s2Toll, -s3, -s3Toll, -walk, -bike, -distance2) # rid new variables
}
```

## Function to add Time to Tours
```{r ToursAddTimeColumn}
# function add_time: attaches the time skims of the given time period (from TIMECODE_VALUES)
# to the given tours data.frame (joining on the columns orig_taz, dest_taz, and timeCode).
# Fills in values to the column 'time' for the given time period based on the column 'costMode'.
# Pass reverse_od as TRUE to do return trip; this uses the dest taz as the origin and the origin
# taz as the dest, and it uses wTrnD time rather than dTrnW.
# Tallies failed times (expected time but -999 found) in the field time_fail
add_time <- function(timeCode_val, tours, reverse_od=FALSE) {
  
  timeSkims   <- read.table(file = file.path(TARGET_DIR,paste0("TimeSkimsDatabase",
                                                               TIMECODE_LABELS[timeCode_val],".csv")), 
                            header=TRUE, sep=",")
  # rename columns for join -- reversing if needed (return trip)
  if (reverse_od) {
    names(timeSkims)[names(timeSkims)=="orig"] <- "dest_taz"  
    names(timeSkims)[names(timeSkims)=="dest"] <- "orig_taz"    
  } else {
    names(timeSkims)[names(timeSkims)=="orig"] <- "orig_taz"  
    names(timeSkims)[names(timeSkims)=="dest"] <- "dest_taz"
  }
  # don't recode -999 as 0 -- we'll deal with it after join
  timeSkims   <- mutate(timeSkims,
                        timeCode = timeCode_val)
  
  # Left join tours to the skims
  tours <- left_join(tours, timeSkims, by=c("orig_taz","dest_taz","timeCode"))
  # assign time value if we can to new column time2
  tours <- mutate(tours,
                  time2=((timeCode==timeCode_val)*(costMode==1)*da    ) +
                        ((timeCode==timeCode_val)*(costMode==2)*daToll) +
                        ((timeCode==timeCode_val)*(costMode==3)*s2    ) +
                        ((timeCode==timeCode_val)*(costMode==4)*s2Toll) +
                        ((timeCode==timeCode_val)*(costMode==5)*s3    ) +
                        ((timeCode==timeCode_val)*(costMode==6)*s3Toll) +
                        ((timeCode==timeCode_val)*(costMode==7)*walk  ) +
                        ((timeCode==timeCode_val)*(costMode==8)*bike  ) +
                        ((timeCode==timeCode_val)*(costMode==9)*wTrnW ) +
                        ((timeCode==timeCode_val)*(costMode==10)*(1-reverse_od)*dTrnW) +
                        ((timeCode==timeCode_val)*(costMode==10)*(reverse_od   *wTrnD))
                  )
  
  tours <- mutate(tours,
                  time_fail2 = ifelse(time2==-999,1,0),    # tally the time_fail
                  time2      = ifelse(time2==-999,0,time2) # reset the -999 to zero
                  )
      
  print(paste("For", TIMECODE_LABELS[timeCode_val], "assigned", prettyNum(sum(!is.na(tours$time2)),big.mark=","),
              "times, with", prettyNum(sum(!is.na(tours$time2)&(tours$time2>0)),big.mark=","),
              "nonzero values"))
  tours$time2[is.na(tours$time2)]           <- 0           # make the unassigned ones 0 for summing
  tours$time_fail2[is.na(tours$time_fail2)] <- 0           # make the unassigned ones 0 for summing
  tours <- mutate(tours, time=time+time2,        # sum
                         time_fail=time_fail+time_fail2)
  print(paste("  -> total nonzero times:",prettyNum(sum(tours$time!=0),big.mark=",")))
  tours <- select(tours, -da, -daToll, -s2, -s2Toll, -s3, -s3Toll, -walk, -bike, -wTrnW, -dTrnW, -wTrnD, -time2, -time_fail2) # rid new variables
}
```

# Trips

## Read Individual Trips and recode a few variables

The fields are documented here: http://analytics.mtc.ca.gov/foswiki/Main/IndividualTrip

```{r ReadIndividualTrips}
indiv_trips     <- read.table(file=file.path(TARGET_DIR,paste0("indivTripData_",ITER,".csv")), header=TRUE, sep=",")
indiv_trips     <- select(indiv_trips, hh_id, person_id, tour_id, orig_taz, dest_taz,
                          trip_mode, orig_purpose, dest_purpose, depart_hour)
```

## Read Joint Trips and recode a few variables

The fields are documented here: http://analytics.mtc.ca.gov/foswiki/Main/JointTrip

```{r ReadJointTrips}
joint_trips     <- read.table(file=file.path(TARGET_DIR,paste0("jointTripData_",ITER,".csv")), header=TRUE, sep=",")
joint_trips     <- select(joint_trips, hh_id, tour_id, orig_taz, dest_taz,
                          trip_mode, orig_purpose, dest_purpose, depart_hour)
```

## Joint Trips need person ids -- attach them (via Joint Tours)

```{r ReadJointTours}
joint_tours    <- read.table(file=file.path(TARGET_DIR,paste0("jointTourData_",ITER,".csv")), header=TRUE, sep=",")
joint_tours    <- select(joint_tours, hh_id, tour_id, tour_participants)

# tour participants are person ids separated by spaces -- create a table of hh_id, person_num for them
joint_tour_persons <- data.frame(hh_id=numeric(), tour_id=numeric(), person_num=numeric())
# unwind particpants into table with cols hh_id, tour_id, person_num1, person_num2, ...
participants   <- strsplit(as.character(joint_tours$tour_participants)," ")
max_peeps      <- max(sapply(participants,length))
participants   <- lapply(participants, function(X) c(X,rep(NA, max_peeps-length(X))))
participants   <- data.frame(t(do.call(cbind, participants)))
participants   <- mutate(participants, hh_id=joint_tours$hh_id, tour_id=joint_tours$tour_id)
# melt the persons so they are each on their own row
for (peep in 1:max_peeps) {
  jtp <- melt(participants, id.var=c("hh_id","tour_id"), measure.vars=paste0("X",peep), na.rm=TRUE)
  jtp <- mutate(jtp, person_num=value)
  jtp <- select(jtp, hh_id, tour_id, person_num)
  joint_tour_persons <- rbind(joint_tour_persons, jtp)
}
joint_tour_persons <- transform(joint_tour_persons, person_num=as.numeric(person_num))
# sort by hh_id
joint_tour_persons <- joint_tour_persons[with(joint_tour_persons, order(hh_id, tour_id)),]
# merge with the persons to get the person_id
joint_tour_persons <- left_join(joint_tour_persons, persons, by=c("hh_id","person_num"))

# attach persons to the joint_trips
joint_person_trips <- inner_join(joint_trips, joint_tour_persons, by=c("hh_id", "tour_id"))
# select out person_num and the person table columns
joint_person_trips <- select(joint_person_trips, hh_id, person_id, tour_id, orig_taz, dest_taz, trip_mode,
                             orig_purpose, dest_purpose, depart_hour)
# cleanup
remove(peep,participants,max_peeps,jtp,joint_tour_persons)
```

## Combine Individual Trips and Joint Person Trips
```{r CombineTrips}
trips <- rbind(indiv_trips, joint_person_trips)
print(paste("Combined",prettyNum(nrow(indiv_trips),big.mark=","),
            "individual trips with",prettyNum(nrow(joint_person_trips),big.mark=","),
            "joint trips to make",prettyNum(nrow(trips),big.mark=",")," total trips"))
remove(indiv_trips,joint_person_trips)
```

## Add active travel time to the Trips
```{r Trips_AddActiveColumn}

# function init_active: creates a few new columns relevant to looking up the active travel time
init_active <- function(trips) {
  trips <- mutate(trips, 
                  amode=1*(trip_mode==7) +                                           # walk
                        2*(trip_mode==8) +                                           # bike
                        3*((trip_mode>=9)&(trip_mode<=13)) +                         # walk trn walk
                        4*((trip_mode>=14)&(trip_mode<=18)&(orig_purpose=='Home')) + # drive trn walk
                        5*((trip_mode>=14)&(trip_mode<=18)&(dest_purpose=='Home')),  # walk trn drive
                  wlk_trip=1*(amode==1),
                  bik_trip=1*(amode==2),
                  wtr_trip=1*(amode==3),
                  dtr_trip=1*(amode==4) + 1*(amode==5),
                  timeCode=1*(depart_hour<6) +                                       # EA
                           2*((depart_hour>5)&(depart_hour<10)) +                    # AM
                           3*((depart_hour>9)&(depart_hour<15)) +                    # MD
                           4*((depart_hour>14)&(depart_hour<19)) +                   # PM
                           5*((depart_hour>18)),                                     # EV
                  active=0
                  )
}

TIMECODE_LABELS <- c("EA","AM","MD","PM","EV")
TIMECODE_VALUES <- c(1,2,3,4,5)

# function add_active: attaches the active skims of the given time period (from TIMECODE_VALUES)
# to the given trip data.frame (joining on the columns orig_taz, dest_taz, and timeCode).
# Fills in values to the column 'active' for the given time period.
add_active <- function(timeCode_val, trips) {

  activeSkims <- read.table(file = file.path(TARGET_DIR,paste0("ActiveTimeSkimsDatabase",TIMECODE_LABELS[timeCode_val],".csv")), header=TRUE, sep=",")
  # rename columns for join
  names(activeSkims)[names(activeSkims)=="orig"] <- "orig_taz"  
  names(activeSkims)[names(activeSkims)=="dest"] <- "dest_taz"
  activeSkims <- mutate(activeSkims,
                        timeCode=timeCode_val,
                        walk2=(walk!=-999)*walk,
                        bike2=(bike!=-999)*bike,
                        wTrnW2=(wTrnW!=-999)*wTrnW,
                        dTrnW2=(dTrnW!=-999)*dTrnW,
                        wTrnD2=(wTrnD!=-999)*wTrnD)
  
  # left join trips to the skims
  trips <- left_join(trips, activeSkims, by=c("orig_taz","dest_taz","timeCode"))
  # assign active value if we can to new column active2
  trips <- mutate(trips,
                  active2=((timeCode==timeCode_val)*(amode==1)*walk2) +
                          ((timeCode==timeCode_val)*(amode==2)*bike2) +
                          ((timeCode==timeCode_val)*(amode==3)*wTrnW2) +
                          ((timeCode==timeCode_val)*(amode==4)*dTrnW2) +
                          ((timeCode==timeCode_val)*(amode==5)*wTrnD2)
                  )
  print(paste("For", TIMECODE_LABELS[timeCode_val], "assigned", prettyNum(sum(!is.na(trips$active2)),big.mark=","),
              "active times, with", prettyNum(sum(!is.na(trips$active2)&(trips$active2>0)),big.mark=","),
              "nonzero values"))
  trips$active2[is.na(trips$active2)] <- 0           # make the unassigned ones 0 for summing
  trips <- mutate(trips, active=active+active2)      # sum
  print(paste("  -> total nonzero active times:",prettyNum(sum(trips$active!=0),big.mark=",")))
  trips <- select(trips, -walk, -bike, -wTrnW, -dTrnW, -wTrnD, -walk2, -bike2, -wTrnW2, -dTrnW2, -wTrnD2, -active2) # rid new variables
}

# go go gadget: Add active transportation time to trips
trips <- init_active(trips)
for (timeCode_val in TIMECODE_VALUES) {
  trips <- add_active(timeCode_val, trips)
}
trips <- tbl_df(trips)
```

# Formatting

## Make an xtable look nice
```{r xtablePretty}
# function make_pretty: pass in labels column and values column of an xtable.
# "Average" values will be decimals.
# "Share" values will be percentages.
# All others will be integers.
xtable_pretty <- function(labels, values) {
  for (rownum in 1:length(values)) {
    if (grepl("Share", labels[rownum])) { 
      values[rownum] <- sprintf("%.1f%%", 100.0*as.numeric(values[rownum]))
    }
    else {
      if (grepl("Average", labels[rownum])) {
        values[rownum] <- sprintf("%.2f", as.numeric(values[rownum]))
      }
      else {
        values[rownum] <- prettyNum(as.integer(values[rownum]), big.mark=",")
      }
    }
  }
  return(values)
}
```

# Active Transportation Summary
```{r ActiveTransportationSummary}
# we only want some variables - sum them to hh_id/person_id
trips_ats   <- select(trips, hh_id, person_id, wlk_trip, bik_trip, wtr_trip, dtr_trip, active)
trips_melt  <- tbl_df(melt(trips_ats, id.vars=c("hh_id","person_id")))
trips_dcast <- tbl_df(dcast(trips_melt, hh_id+person_id ~ variable, fun.aggregate=sum))
# left join with persons --> one row per person!
trips_by_person <- left_join(select(persons, hh_id, person_id, ptype, activity_pattern, value_of_time), 
                             trips_dcast, by=c("hh_id","person_id"))

# append autos, taz, COUNTY from households
trips_by_person <- left_join(trips_by_person, select(households, hh_id, autos, taz, COUNTY), by=c("hh_id"))
# recode zeroAuto
trips_by_person <- mutate(trips_by_person, 
                          zeroAuto=(autos==0),
                          atHomeA=is.na(active))
# set NAs to zero
trips_by_person$wlk_trip[is.na(trips_by_person$wlk_trip)] <- 0
trips_by_person$bik_trip[is.na(trips_by_person$bik_trip)] <- 0
trips_by_person$wtr_trip[is.na(trips_by_person$wtr_trip)] <- 0
trips_by_person$dtr_trip[is.na(trips_by_person$dtr_trip)] <- 0
trips_by_person$active[is.na(trips_by_person$active)] <- 0

trips_by_person <- mutate(trips_by_person, more15=(active>=15), more30=(active>=30))

# summarize
active_summary <- summarise(group_by(trips_by_person, taz, COUNTY, ptype, zeroAuto), 
                            freq     = n(),
                            active   = mean(active),
                            more15   = mean(more15),
                            more30   = mean(more30),
                            wlk_trip = mean(wlk_trip),
                            bik_trip = mean(bik_trip),
                            wtr_trip = mean(wtr_trip),
                            dtr_trip = mean(dtr_trip),
                            atHomeA  = mean(atHomeA))

write.table(active_summary, file.path(TARGET_DIR,"summary","ActiveTransport.csv"), sep=",", row.names=FALSE)
summary <- active_summary  # name it generically for rdata
save(summary, file=file.path(TARGET_DIR,"summary","ActiveTransport.rdata"))
```

## Active Travel Summary - Overall
```{r ActiveTransportationSummary_overall, results='asis', echo=FALSE, eval=FALSE}
# function active_summary_to_xtable: updates the active_summary table by:
# - multiplying trip rates to get number of trips
# - combining walk-transit and drive-transit
# - creating a formatted xtable for printing
active_summary_to_xtable <- function(active_summary, caption) {
  # multiply the trip rates by the number of people to get number of trips
  active_summary[,6:9]      <- active_summary[,6:9]*active_summary[,1]
  # combine walk-transit and drive-transit to transit
  active_summary            <- mutate(active_summary, tr_trip=dtr_trip+wtr_trip)
  # transpose it
  active_summary_t          <- tbl_df(as.data.frame(t(active_summary)))
  # add category and measure columns
  print(active_summary_t)
  active_summary_t$Category <- c("Regional"," ",
                                 "Active travel"," "," "," ",
                                 " "," "," "," ")
  active_summary_t$Measure  <- c("Population",
                                 "Share of population that does not leave home on a typical weekday",
                                 "Average minutes of active travel per person per typical weekday",
                                 "Share of the population that engages in at least 15 minutes of active travel per typical weekday",
                                 "Share of the population that engages in at least 30 minutes of active travel per typical weekday",
                                 "Total walk trips (excluding walking as part of transit travel",
                                 "Total bicycle trips",
                                 "Walk trips which are part of walk to transit travel per person",
                                 "Walk trips which are part of drive to transit travel per person",
                                 "Walk trips which are part of transit travel per person")
  # reorder columns
  colnames                  <- append(tail(colnames(active_summary_t),2), 
                                      head(colnames(active_summary_t),length(colnames(active_summary_t))-2))
  active_summary_t          <- active_summary_t[colnames]
  active_summary_xtable     <- xtable(active_summary_t,
                                      caption=caption
                                      # align="lllr"
                                      )
  return(active_summary_xtable)
}

active_summary_all <- summarise(trips_by_person, 
                            freq     = n(),
                            atHomeA  = mean(atHomeA),
                            active   = mean(active),
                            more15   = mean(more15),
                            more30   = mean(more30),
                            wlk_trip = mean(wlk_trip),
                            bik_trip = mean(bik_trip),
                            wtr_trip = mean(wtr_trip),
                            dtr_trip = mean(dtr_trip)
                            )
# convert to xtable
active_summary_all_xtable              <- active_summary_to_xtable(active_summary_all, "Active Travel - Regional Summary")
# rename column
colnames(active_summary_all_xtable)[3] <- "Quantity"
# format the numbers
active_summary_all_xtable$Quantity     <- xtable_pretty(active_summary_all_xtable$Measure, active_summary_all_xtable$Quantity)
print(active_summary_all_xtable, type="html", include.rownames=FALSE)
```

## Active Travel Summary - By Person Type
```{r ActiveTransportationSummary_ptype, results='asis', echo=FALSE, eval=FALSE}
active_summary_ptype <- summarise(group_by(trips_by_person, ptype),
                            freq     = n(),
                            atHomeA  = mean(atHomeA),
                            active   = mean(active),
                            more15   = mean(more15),
                            more30   = mean(more30),
                            wlk_trip = mean(wlk_trip),
                            bik_trip = mean(bik_trip),
                            wtr_trip = mean(wtr_trip),
                            dtr_trip = mean(dtr_trip)
                            )
active_summary_ptype <- select(active_summary_ptype, -ptype)
# convert to xtable
active_summary_ptype_xtable                <- active_summary_to_xtable(active_summary_ptype,"Active Travel By Person Type")
# rename column
colnames(active_summary_ptype_xtable)[3:length(colnames(active_summary_ptype_xtable))] <- PTYPE_LABELS
# format the numbers
for (ptype_val in PTYPE_LABELS) {
  active_summary_ptype_xtable[[ptype_val]] <- xtable_pretty(active_summary_ptype_xtable$Measure, 
                                                            get(ptype_val, active_summary_ptype_xtable))
}
print(active_summary_ptype_xtable, type="html", include.rownames=FALSE)
```

## Active Travel Summary - By County of Residence
```{r ActiveTransportationSummary_county, results='asis', echo=FALSE, eval=FALSE}
active_summary_county <- summarise(group_by(trips_by_person, COUNTY),
                            freq     = n(),
                            atHomeA  = mean(atHomeA),
                            active   = mean(active),
                            more15   = mean(more15),
                            more30   = mean(more30),
                            wlk_trip = mean(wlk_trip),
                            bik_trip = mean(bik_trip),
                            wtr_trip = mean(wtr_trip),
                            dtr_trip = mean(dtr_trip)
                            )
identical(as.integer(active_summary_county$COUNTY), as.integer(c(1,2,3,4,5,6,7,8,9)))
active_summary_county <- select(active_summary_county, -COUNTY)
# convert to xtable
active_summary_county_xtable                <- active_summary_to_xtable(active_summary_county,"Active Travel By County of Residence")
# rename column
colnames(active_summary_county_xtable)[3:length(colnames(active_summary_county_xtable))] <- COUNTY_LABELS
# format the numbers
for (county_val in COUNTY_LABELS) {
  active_summary_county_xtable[[county_val]] <- xtable_pretty(active_summary_county_xtable$Measure, 
                                                            get(county_val, active_summary_county_xtable))
}
print(active_summary_county_xtable, type="html", include.rownames=FALSE)
```

## Active Travel Summary - By Automobile Ownership
```{r ActiveTransportationSummary_zeroauto, results='asis', echo=FALSE, eval=FALSE}
active_summary_zerauto <- summarise(group_by(trips_by_person, zeroAuto),
                            freq     = n(),
                            atHomeA  = mean(atHomeA),
                            active   = mean(active),
                            more15   = mean(more15),
                            more30   = mean(more30),
                            wlk_trip = mean(wlk_trip),
                            bik_trip = mean(bik_trip),
                            wtr_trip = mean(wtr_trip),
                            dtr_trip = mean(dtr_trip)
                            )
print(active_summary_zerauto$zeroAuto)
identical(as.integer(active_summary_zerauto$zeroAuto), as.integer(c(0,1)))
active_summary_zerauto <- select(active_summary_zerauto, -zeroAuto)
# convert to xtable
active_summary_zerauto_xtable                <- active_summary_to_xtable(active_summary_zerauto,"Active Travel By Auto Ownership")
# rename column
zerauto_labels                               <- c("Non-zero Automobiles", "Zero Automobiles")
colnames(active_summary_zerauto_xtable)[3:length(colnames(active_summary_zerauto_xtable))] <- zerauto_labels
# format the numbers
for (zerauto_val in zerauto_labels) {
  active_summary_zerauto_xtable[[zerauto_val]] <- xtable_pretty(active_summary_zerauto_xtable$Measure, 
                                                            get(zerauto_val, active_summary_zerauto_xtable))
}
print(active_summary_zerauto_xtable, type="html", include.rownames=FALSE)
```

# Activity Pattern Summary
```{r ActivityPatternSummary}
actpatt_summary <- summarise(group_by(persons, type, activity_pattern, imf_choice, inmf_choice, incQ), freq=n())
write.table(actpatt_summary, file.path(TARGET_DIR,"summary","ActivityPattern.csv"), sep=",", row.names=FALSE)
summary <- actpatt_summary  # name it generically for rdata
save(summary, file=file.path(TARGET_DIR,"summary","ActivityPattern.rdata"))
```

# Auto Ownership Summaries
```{r AutoOwnershipSummary}
# summarise
autoown_summary <- summarise(group_by(households, SD, COUNTY, autos, incQ, walk_subzone, workers, kidsNoDr), freq=n())
write.table(autoown_summary, file.path(TARGET_DIR,"summary","AutomobileOwnership.csv"), sep=",", row.names=FALSE)
summary <- autoown_summary  # name it generically for rdata
save(summary, file=file.path(TARGET_DIR,"summary","AutomobileOwnership.rdata"))
```

## Auto Ownership Summary By County
```{r AutoOwnershipSummaryByCountyGraph, fig.width=8, fig.height=5}
auto_labels <- c("Zero automobiles", "One automobile", "Two automobiles",
                 "Three automobiles", "Four or more automobiles")

# by County
autoown_summary_county <- summarise(group_by(autoown_summary, COUNTY, autos), freq=sum(freq))
ggplot(autoown_summary_county, aes(x=as.factor(COUNTY), y=freq, fill=as.factor(autos))) +
  geom_bar(stat="identity", position="fill") +
  scale_y_continuous(labels=percent, breaks=seq(0,1,0.1)) +
  scale_x_discrete(labels=COUNTY_LABELS) +
  xlab("County of Residence") + 
  ylab("Share of Households") +
  ggtitle("Households by Automobile Ownership and County of Residence") +
  scale_fill_discrete(name="", 
                      breaks=c(4,3,2,1,0), 
                      labels=rev(auto_labels))
```

```{r AutoOwnershipSummaryByCountyTable, results='asis', echo=FALSE, eval=FALSE}
aos_ac_table                     <- dcast(autoown_summary_county, autos ~ COUNTY, value.var="freq")
# make rownames readable

rownames(aos_ac_table)           <- auto_labels
aos_ac_table                     <- select(aos_ac_table, -autos)
# add Sum row and name it Everyone
aos_ac_table_summed              <- addmargins(as.table(as.matrix(aos_ac_table)), 1, FUN=sum)
rownames(aos_ac_table_summed)[6] <- "Everyone"
# name columns
colnames(aos_ac_table_summed)    <- COUNTY_LABELS
aos_ac_xtable                    <- xtable(apply(aos_ac_table_summed, 2, prettyNum, big.mark=","), 
                                         align="lrrrrrrrrr",
                                         caption="Automobile Ownership Levels by County")
print(aos_ac_xtable, type="html")


# shares
aos_ac_table_share              <- prop.table(as.table(as.matrix(aos_ac_table)),2)
aos_ac_table_share              <- addmargins(aos_ac_table_share, 1, FUN=sum)
rownames(aos_ac_table_share)[6] <- "Everyone"
colnames(aos_ac_table_share)    <- COUNTY_LABELS
aos_ac_xtable_share             <- xtable(apply(aos_ac_table_share, 2, function(u) sprintf("%.1f%%",u*100)),
                                        align="lrrrrrrrrr",
                                        caption="Automobile Ownership Share by County")
rownames(aos_ac_xtable_share)   <- append(auto_labels,"Everyone")
print(aos_ac_xtable_share, type="html")
```

## Auto Ownership Summary By Workers
```{r AutoOwnershipSummaryByWorkersGraph, fig.width=8, fig.height=5}
# by Workers
autoown_summary_workers <- summarise(group_by(autoown_summary, workers, autos), freq=sum(freq))

ggplot(autoown_summary_workers, aes(x=as.factor(workers), y=freq, fill=as.factor(autos))) +
  geom_bar(stat="identity", position="fill") +
  scale_y_continuous(labels=percent, breaks=seq(0,1,0.1)) +
  scale_x_discrete(labels=WORKER_LABELS) +
  xlab("Workers in the Household") + 
  ylab("Share of Households") +
  ggtitle("Households by Automobile Ownership and Number of Workers") +
  scale_fill_discrete(name="", 
                      breaks=c(4,3,2,1,0), 
                      labels=rev(auto_labels))
```

```{r AutoOwnershipSummaryByWorkersTable, results='asis', echo=FALSE}
aos_aw_table <- dcast(autoown_summary_workers, autos ~ workers, value.var="freq")
# make rownames readable
# stopifnot(aos_aw_table$autos == c(0,1,2,3,4))
rownames(aos_aw_table)           <- auto_labels
aos_aw_table                     <- select(aos_aw_table, -autos)
# add Sum row and name it Everyone
aos_aw_table_summed              <- addmargins(as.table(as.matrix(aos_aw_table)), 1, FUN=sum)
rownames(aos_aw_table_summed)[6] <- "Everyone"
# name columns
colnames(aos_aw_table_summed)    <- WORKER_LABELS
aosw_xtable                      <- xtable(apply(aos_aw_table_summed, 2, prettyNum, big.mark=","), 
                                           align="lrrrrr",
                                           caption="Automobile Ownership Levels by Number of Workers")
print(aosw_xtable, type="html")


# shares
aos_aw_table_share              <- prop.table(as.table(as.matrix(aos_aw_table)),2)
aos_aw_table_share              <- addmargins(aos_aw_table_share, 1, FUN=sum)
rownames(aos_aw_table_share)[6] <- "Everyone"
colnames(aos_aw_table_share)    <- WORKER_LABELS
aosw_xtable_share               <- xtable(apply(aos_aw_table_share, 2, function(u) sprintf("%.1f%%",u*100)),
                                          align="lrrrrr",
                                          caption="Automobile Ownership Share by Number of Workers")
rownames(aosw_xtable_share)     <- append(auto_labels,"Everyone")
print(aosw_xtable_share, type="html")
```

## Average Auto Ownership Summary By County and Transit Availability
```{r AutoOwnershipSummaryByCountyTrnAvailGraph, fig.width=8, fig.height=5}
# by Workers
autoown_summary_trncoutny <- summarise(group_by(autoown_summary, COUNTY, walk_subzone, autos), freq=sum(freq))
autoown_summary_trncoutny <- mutate(autoown_summary_trncoutny, totautos=autos*freq)
# ggplot(autoown_summary_workers, aes(x=as.factor(workers), y=freq, fill=as.factor(autos))) +
#  geom_bar(stat="identity", position="fill") +
#  scale_y_continuous(labels=percent, breaks=seq(0,1,0.1)) +
#  scale_x_discrete(labels=WORKER_LABELS) +
#  xlab("Workers in the Household") + 
#  ylab("Share of Households") +
#  ggtitle("Households by Automobile Ownership and Number of Workers") +
#  scale_fill_discrete(name="", 
#                      breaks=c(4,3,2,1,0), 
#                      labels=rev(auto_labels))
```

```{r AutoOwnershipSummaryByCountyTrnAvailTable, results='asis', echo=FALSE}
# households in walk_subzones x county
aos_wc_table                  <- dcast(autoown_summary_trncoutny, walk_subzone ~ COUNTY, 
                                       value.var="freq", fun.aggregate=sum)
# stopifnot(aos_wc_table$walk_subzone == c(0,1,2))
rownames(aos_wc_table)        <- WALK_SUBZONE_LABELS
aos_wc_table                  <- select(aos_wc_table, -walk_subzone)
aos_wc_table_summed           <- addmargins(as.table(as.matrix(aos_wc_table)), 1, FUN=sum)

# total autos in walk_subzones x county
aos_wc_table_totaut           <- dcast(autoown_summary_trncoutny, walk_subzone ~ COUNTY, 
                                       value.var="totautos", fun.aggregate=sum)
# stopifnot(aos_wc_table_totaut$walk_subzone == c(0,1,2))
rownames(aos_wc_table_totaut) <- WALK_SUBZONE_LABELS
aos_wc_table_totaut           <- select(aos_wc_table_totaut, -walk_subzone)
aos_wc_table_totaut_summed    <- addmargins(as.table(as.matrix(aos_wc_table_totaut)), 1, FUN=sum)

# avg autos in walk_subzones x county
aos_wc_table_avgaut           <- aos_wc_table_totaut_summed/aos_wc_table_summed
rownames(aos_wc_table_avgaut)[4] <- "Everyone"
colnames(aos_wc_table_avgaut) <- COUNTY_LABELS
aos_wc_xtable_avgaut          <- xtable(apply(aos_wc_table_avgaut, 2, function(u) sprintf("%.2f",u)), 
                                        align="lrrrrrrrrr",
                                        caption=paste("Average Automobile Ownership Levels",
                                                      "(capped at 4 per household) by County ",
                                                      "and Walk-to-Transit Accessibility"))
rownames(aos_wc_xtable_avgaut)<- append(WALK_SUBZONE_LABELS, "Everyone")
print(aos_wc_xtable_avgaut, type="html")

# number of households in walk_subzones x county
rownames(aos_wc_table_summed)[4] <- "Everyone"
colnames(aos_wc_table_summed) <- COUNTY_LABELS
aos_wc_xtable_summed          <- xtable(apply(aos_wc_table_summed, 2, prettyNum, big.mark=","), 
                                        align="lrrrrrrrrr",
                                        caption=paste("Number of households by County",
                                                      "and Walk-to-Transit Accessibility"))
rownames(aos_wc_xtable_summed)<- append(WALK_SUBZONE_LABELS, "Everyone")
print(aos_wc_xtable_summed, type="html")

```

# Commute By Employment Location Summaries
```{r CommuteByEmploymentLocationSummary}
commute_tours   <- select(indiv_tours, hh_id, person_id, orig_taz, dest_taz, tour_purpose, start_hour, end_hour, tour_mode, incQ)
# select out non-work travel
commute_tours   <- subset(commute_tours, (tour_purpose!="atwork_business" & tour_purpose!="atwork_eat"  & tour_purpose!="atwork_maint" &
                                          tour_purpose!="eatout"          & tour_purpose!="escort_kids" & tour_purpose!="escort_no kids" &
                                          tour_purpose!="othdiscr"        & tour_purpose!="othmaint"    & tour_purpose!="school_grade" &
                                          tour_purpose!="school_high"     & tour_purpose!="shopping"    & tour_purpose!="social" &
                                          tour_purpose!="university"))

# TODO: add this to all tours, not just commute?
# The cost database contains simplified transit modes, build a cross-walk from the full modes;
commute_tours   <- mutate(commute_tours, 
                          costMode  =(tour_mode<=8)*tour_mode +         # auto, walk, bike all in the skims
                                     # All walk to transit sub modes get best path walk to transit skim
                                     (tour_mode>=9)*(tour_mode<=13)*9 +
                                     # All drive transit walk sub modes get the best path drive transit walk skim (tours start at home)
                                     (tour_mode>=14)*10,
                          timeCodeHw=(start_hour<6)*1 +                  # EA
                                     (start_hour>5)*(start_hour<10)*2 +  # AM
                                     (start_hour>9)*(start_hour<15)*3 +  # MD
                                     (start_hour>14)*(start_hour<19)*4 + # PM
                                     (start_hour>18)*5,                  # EV
                          timeCodeWh=(end_hour<6)*1 +                  # EA
                                     (end_hour>5)*(end_hour<10)*2 +    # AM
                                     (end_hour>9)*(end_hour<15)*3 +    # MD
                                     (end_hour>14)*(end_hour<19)*4 +   # PM
                                     (end_hour>18)*5                   # EV
                          )


# Add in County, Superdistrict, Parking Cost from TAZ Data for the employment location (the tour destination)
commute_tours   <- left_join(commute_tours,
                             mutate(tazData, dest_taz=taz) %.% select(dest_taz, COUNTY, SD, PRKCST),
                             by=c("dest_taz"))

# Initialize for home-work cost lookup
commute_tours   <- mutate(commute_tours, timeCode=timeCodeHw, cost=0.0, cost_fail=0)
# Add home-work cost to tours
for (timeCode_val in TIMECODE_VALUES) {
  commute_tours <- add_cost(timeCode_val, commute_tours, reverse_od=FALSE)
}
# That set it as cost, so rename
commute_tours   <- mutate(commute_tours, hwCost=cost)
# Add distance to tours
commute_tours   <- mutate(commute_tours, distance=0.0)
for (timeCode_val in TIMECODE_VALUES) {
  commute_tours <- add_distance(timeCode_val, commute_tours)
}

# Add time
commute_tours   <- mutate(commute_tours, time=0.0, time_fail=0)
for (timeCode_val in TIMECODE_VALUES) {
  commute_tours <- add_time(timeCode_val, commute_tours)
}


# Initialize for work-home cost lookup.
commute_tours   <- mutate(commute_tours, timeCode=timeCodeWh, cost=0.0)
# Add work-home cost to tours
for (timeCode_val in TIMECODE_VALUES) {
  commute_tours <- add_cost(timeCode_val, commute_tours, reverse_od=TRUE)
}
# That set it as cost, so rename
commute_tours   <- mutate(commute_tours, whCost=cost)
# Save cost as the average of hwCost and whCost
commute_tours   <- mutate(commute_tours, cost=0.5*(hwCost+whCost))

# Calculate the duration
commute_tours   <- mutate(commute_tours,
                          duration=end_hour-start_hour+0.5)

# Get the free-parking choice from persons
commute_tours   <- left_join(commute_tours,
                             select(persons, person_id, fp_choice),
                             by=c("person_id"))

# Compute the tour parking cost
commute_tours   <- mutate(commute_tours, parking_rate=ifelse(fp_choice==1,0.0,PRKCST))
commute_tours   <- mutate(commute_tours, parking_cost=parking_rate*duration)
# Distribute costs across shared ride modes (same value used in skims, assignment);
commute_tours   <- mutate(commute_tours, parking_cost=ifelse((tour_mode==3)|(tour_mode==4),parking_cost/1.75,parking_cost))
commute_tours   <- mutate(commute_tours, parking_cost=ifelse((tour_mode==5)|(tour_mode==6),parking_cost/2.50,parking_cost))
# Set the transit parking cost to zero
commute_tours   <- mutate(commute_tours, parking_cost=ifelse(tour_mode>6,0.0,parking_cost))
# Sum parking and out-of-pocket cost
commute_tours   <- mutate(commute_tours, totCost=cost+parking_cost)

# tours with failures should be dropped from the mean
commute_tours$totCost[commute_tours$cost_fail>0] <- NA
commute_tours$cost[commute_tours$cost_fail>0]    <- NA
commute_tours$time[commute_tours$time_fail>0]    <- NA

# summarise
commute_summary <- summarise(group_by(commute_tours, COUNTY, SD, tour_mode), 
                             freq         = n(),
                             totCost      = mean(totCost, na.rm=TRUE),
                             cost         = mean(cost,    na.rm=TRUE),
                             parking_cost = mean(parking_cost),
                             distance     = mean(distance),
                             cost_fail    = sum(cost_fail))
write.table(commute_summary, file.path(TARGET_DIR,"summary","CommuteByEmploymentLocation.csv"), sep=",", row.names=FALSE)
summary <- commute_summary  # name it generically for rdata
save(summary, file=file.path(TARGET_DIR,"summary","CommuteByEmploymentLocation.rdata"))
```

# Commute By Income Summaries
```{r CommuteByIncomeSummary}
commute_inc_summary_byjob <- summarise(group_by(commute_tours, COUNTY, SD, dest_taz, tour_mode, incQ), 
                                       freq         = n(),
                                       totCost      = mean(totCost, na.rm=TRUE),
                                       cost         = mean(cost,    na.rm=TRUE),
                                       parking_cost = mean(parking_cost),
                                       distance     = mean(distance),
                                       duration     = mean(time,    na.rm=TRUE),
                                       cost_fail    = sum(cost_fail),
                                       time_fail    = sum(time_fail))
write.table(commute_inc_summary_byjob, 
            file.path(TARGET_DIR,"summary","CommuteByIncomeJob.csv"), sep=",", row.names=FALSE)
summary <- commute_inc_summary_byjob  # name it generically for rdata
save(summary, file=file.path(TARGET_DIR,"summary","CommuteByIncomeJob.rdata"))

# The COUNTY and super district are by destination right now; add residence
commute_tours   <- left_join(commute_tours,
                             mutate(tazData, orig_taz=taz, res_COUNTY=COUNTY, res_SD=SD) %.% select(orig_taz, res_COUNTY, res_SD),
                             by=c("orig_taz"))
commute_inc_summary_byres <- summarise(group_by(commute_tours, res_COUNTY, res_SD, orig_taz, tour_mode, incQ), 
                                       freq         = n(),
                                       totCost      = mean(totCost, na.rm=TRUE),
                                       cost         = mean(cost,    na.rm=TRUE),
                                       parking_cost = mean(parking_cost),
                                       distance     = mean(distance),
                                       duration     = mean(time,    na.rm=TRUE),
                                       cost_fail    = sum(cost_fail),
                                       time_fail    = sum(time_fail))
write.table(commute_inc_summary_byres, 
            file.path(TARGET_DIR,"summary","CommuteByIncomeHousehold.csv"), sep=",", row.names=FALSE)
summary <- commute_inc_summary_byres  # name it generically for rdata
save(summary, file=file.path(TARGET_DIR,"summary","CommuteByIncomeHousehold.rdata"))
```
