---
title: "Core Summaries"
author: "Lisa Zorn"
date: "Friday, August 01, 2014"
output:
  html_document:
    css: custom.css
    toc: yes
# runtime: shiny
---

This R Markdown document is made interactive using Shiny. Unlike the more traditional workflow of creating static reports, you can now create documents that allow your readers to change the assumptions underlying your analysis and see the results immediately. 

To learn more, see [Interactive Documents](http://rmarkdown.rstudio.com/authoring_shiny.html).

# Initialization: Set the workspace and load needed libraries
```{r Initialization}
library(knitr)
library(ggplot2)
library(scales)
library(xtable)
library(dplyr)
library(reshape2)

# run test mode?  It's a short version
TEST        <- FALSE

ITER        <- 3
SRC_DIR     <- "C:/Users/lzorn/Documents/2010_04_ZZZ"
POPSYN_HH   <- "hhFile.p2011s3a1.2010"
POPSYN_PERS <- "personFile.p2011s3a1.2010"

if (TEST) {
  ITER        <- 1
  SRC_DIR     <- "C:/Users/lzorn/Documents/2020_03_116"
  POPSYN_HH   <- "hhFile.p2011s6g.2020"
  POPSYN_PERS <- "personFile.p2011s6g.2020"
}

opts_knit$set(root.dir=SRC_DIR)
# this is for running outside of knitr
setwd(SRC_DIR)
# this is where we'll write results
if (!file.exists("summary")) {
  dir.create("summary")
}
```

# Household files

## Read the household files and land use file

There are two household files:

 * the model input file from the synthesized household/population (http://analytics.mtc.ca.gov/foswiki/Main/PopSynHousehold)
 * the model output file (http://analytics.mtc.ca.gov/foswiki/Main/Household)

The land use file: http://analytics.mtc.ca.gov/foswiki/Main/TazData

```{r ReadHouseholds}
input.pop.households <- read.table(file = paste0(POPSYN_HH,".csv"), header=TRUE, sep=",")
input.ct.households  <- read.table(file = paste0("householdData_",ITER,".csv"), header=TRUE, sep = ",")
walk_subzone_labels  <- c("Cannot walk to transit (more than two-thirds of a mile away)",
                          "Short-walk to transit (less than one-third of a mile)",
                          "Long-walk to transit (between one-third and two-thirds of a mile)")

input.tazData <- read.table(file="tazData.csv", header=TRUE, sep=",")
county_labels <- c("San\nFrancisco","San\nMateo","Santa\nClara","Alameda",
                   "Contra\nCosta","Solano","Napa","Sonoma","Marin")
```

## Join them

Rename/drop some columns and join them on household id. Also join with tazData to get the super district and county.

```{r JoinHouseholds}
input.pop.households <- select(input.pop.households, HHID, PERSONS, hworkers, huniv, hpresch, hschpred, hschdriv)
input.ct.households  <- select(input.ct.households, -jtf_choice)
input.tazData        <- select(input.tazData, ZONE, SD, COUNTY)

# rename
names(input.pop.households)[names(input.pop.households)=="HHID"] <- "hh_id"
names(input.tazData)[names(input.tazData)=="ZONE"] <- "taz"

households <- inner_join(input.pop.households, input.ct.households, "hh_id")
households <- inner_join(households, input.tazData, "taz")
# wrap as a d data frame tbl so it's nicer for printing
households <- tbl_df(households)
# clean up
remove(input.pop.households, input.ct.households)
```


## Recode a few new variables
```{r RecodeHouseholdVars}
# incQ are Income Quartiles
households    <- mutate(households, incQ=1*(income<30000) + 
                                         2*((income>=30000)&(income<60000)) +
                                         3*((income>=60000)&(income<100000)) +
                                         4*(income>=100000))

# workers are hworkers capped at 4
households    <- mutate(households, workers=4*(hworkers>=4) + hworkers*(hworkers<4))
worker_labels <- c("Zero", "One", "Two", "Three", "Four or more")

# kidsNoDr is 1 if the household has children in the househole that don't drive
# (either pre-school age or school age)
households    <- mutate(households, kidsNoDr=(hpresch>=1)|(hschpred>=1))
```

# Person files

There are two person files:

 * the model input file from the synthesized household/population (http://analytics.mtc.ca.gov/foswiki/Main/PopSynPerson)
 * the model output file (http://analytics.mtc.ca.gov/foswiki/Main/Person)

## Read the person files
```{r ReadPersons}
input.pop.persons    <- read.table(file = paste0(POPSYN_PERS,".csv"), header=TRUE, sep=",")
input.ct.persons     <- read.table(file = paste0("personData_",ITER,".csv"), header=TRUE, sep = ",")
```

## Join them
```{r}
ptype_labels         <- c("Full-time worker","Part-time worker","College student","Non-working adult","Retired",
                          "Driving-age student","Non-driving-age student","Child too young for school")

# Rename
names(input.pop.persons)[names(input.pop.persons)=="HHID"] <- "hh_id"
names(input.pop.persons)[names(input.pop.persons)=="PERID"] <- "person_id"

# Inner join so persons must be present in both.  So only simulated persons stay.
persons <- inner_join(input.pop.persons, input.ct.persons, by=c("hh_id", "person_id"))
# Get incQ from Households
persons <- left_join(persons, select(households, hh_id, incQ), by=c("hh_id"))

# wrap as a d data frame tbl so it's nicer for printing
persons              <- tbl_df(persons)
# clean up
remove(input.pop.persons, input.ct.persons)
```

# Trips

## Read Individual Trips and recode a few variables

The fields are documented here: http://analytics.mtc.ca.gov/foswiki/Main/IndividualTrip

```{r ReadIndividualTrips}
indiv_trips     <- read.table(file=paste0("indivTripData_",ITER,".csv"), header=TRUE, sep=",")
indiv_trips     <- select(indiv_trips, hh_id, person_id, tour_id, orig_taz, dest_taz,
                          trip_mode, orig_purpose, dest_purpose, depart_hour)
```

## Read Joint Trips and recode a few variables

The fields are documented here: http://analytics.mtc.ca.gov/foswiki/Main/JointTrip

```{r ReadJointTrips}
joint_trips     <- read.table(file=paste0("jointTripData_",ITER,".csv"), header=TRUE, sep=",")
joint_trips     <- select(joint_trips, hh_id, tour_id, orig_taz, dest_taz,
                          trip_mode, orig_purpose, dest_purpose, depart_hour)
```

## Joint Trips need person ids -- attach them (via Joint Tours)

```{r readJointTours}
joint_tours    <- read.table(file=paste0("jointTourData_",ITER,".csv"), header=TRUE, sep=",")
joint_tours    <- select(joint_tours, hh_id, tour_id, tour_participants)

# tour participants are person ids separated by spaces -- create a table of hh_id, person_num for them
joint_tour_persons <- data.frame(hh_id=numeric(), tour_id=numeric(), person_num=numeric())
# unwind particpants into table with cols hh_id, tour_id, person_num1, person_num2, ...
participants   <- strsplit(as.character(joint_tours$tour_participants)," ")
max_peeps      <- max(sapply(participants,length))
participants   <- lapply(participants, function(X) c(X,rep(NA, max_peeps-length(X))))
participants   <- data.frame(t(do.call(cbind, participants)))
participants   <- mutate(participants, hh_id=joint_tours$hh_id, tour_id=joint_tours$tour_id)
# melt the persons so they are each on their own row
for (peep in 1:max_peeps) {
  jtp <- melt(participants, id.var=c("hh_id","tour_id"), measure.vars=paste0("X",peep), na.rm=TRUE)
  jtp <- mutate(jtp, person_num=value)
  jtp <- select(jtp, hh_id, tour_id, person_num)
  joint_tour_persons <- rbind(joint_tour_persons, jtp)
}
joint_tour_persons <- transform(joint_tour_persons, person_num=as.numeric(person_num))
# sort by hh_id
joint_tour_persons <- joint_tour_persons[with(joint_tour_persons, order(hh_id, tour_id)),]
# merge with the persons to get the person_id
joint_tour_persons <- left_join(joint_tour_persons, persons, by=c("hh_id","person_num"))

# attach persons to the joint_trips
joint_person_trips <- inner_join(joint_trips, joint_tour_persons, by=c("hh_id", "tour_id"))
# select out person_num and the person table columns
joint_person_trips <- select(joint_person_trips, hh_id, person_id, tour_id, orig_taz, dest_taz, trip_mode,
                             orig_purpose, dest_purpose, depart_hour)
# cleanup
remove(peep,participants,max_peeps,jtp,joint_tour_persons)
```

## Combine Individual Trips and Joint Person Trips
```{r combineTrips}
trips <- rbind(indiv_trips, joint_person_trips)
print(paste("Combined",prettyNum(nrow(indiv_trips),big.mark=","),
            "individual trips with",prettyNum(nrow(joint_person_trips),big.mark=","),
            "joint trips to make",prettyNum(nrow(trips),big.mark=",")," total trips"))
remove(indiv_trips,joint_person_trips)
```

## Add active travel time to the Trips
```{r addActiveColumn}

# function init_active: creates a few new columns relevant to looking up the active travel time
init_active <- function(trips) {
  trips <- mutate(trips, 
                  amode=1*(trip_mode==7) +                                           # walk
                        2*(trip_mode==8) +                                           # bike
                        3*((trip_mode>=9)&(trip_mode<=13)) +                         # walk trn walk
                        4*((trip_mode>=14)&(trip_mode<=18)&(orig_purpose=='Home')) + # drive trn walk
                        5*((trip_mode>=14)&(trip_mode<=18)&(dest_purpose=='Home')),  # walk trn drive
                  wlk_trip=1*(amode==1),
                  bik_trip=1*(amode==2),
                  wtr_trip=1*(amode==3),
                  dtr_trip=1*(amode==4) + 1*(amode==5),
                  timeCode=1*(depart_hour<6) +                                       # EA
                           2*((depart_hour>5)&(depart_hour<10)) +                    # AM
                           3*((depart_hour>9)&(depart_hour<15)) +                    # MD
                           4*((depart_hour>14)&(depart_hour<19)) +                   # PM
                           5*((depart_hour>18)),                                     # EV
                  active=0
                  )
}

timeCode_labels <- c("EA","AM","MD","PM","EV")
timeCode_values <- c(1,2,3,4,5)

# function add_active: attaches the active skims of the given time period (from timeCode_values)
# to the given trip data.frame (joining on the columns orig_taz, dest_taz, and timeCode).
# Fills in values to the column 'active' for the given time period.
add_active <- function(timeCode_val, trips) {

  timeCode    <- timeCode_labels[timeCode_val]
  activeSkims <- read.table(file = paste0("ActiveTimeSkimsDatabase",timeCode,".csv"), header=TRUE, sep=",")
  # rename columns for join
  names(activeSkims)[names(activeSkims)=="orig"] <- "orig_taz"  
  names(activeSkims)[names(activeSkims)=="dest"] <- "dest_taz"
  activeSkims <- mutate(activeSkims,
                        timeCode=timeCode_val,
                        walk2=(walk!=-999)*walk,
                        bike2=(bike!=-999)*bike,
                        wTrnW2=(wTrnW!=-999)*wTrnW,
                        dTrnW2=(dTrnW!=-999)*dTrnW,
                        wTrnD2=(wTrnD!=-999)*wTrnD)
  
  # left join trips to the skims
  trips <- left_join(trips, activeSkims, by=c("orig_taz","dest_taz","timeCode"))
  # assign active value if we can to new column active2
  trips <- mutate(trips,
                  active2=((timeCode==timeCode_val)*(amode==1)*walk2) +
                          ((timeCode==timeCode_val)*(amode==2)*bike2) +
                          ((timeCode==timeCode_val)*(amode==3)*wTrnW2) +
                          ((timeCode==timeCode_val)*(amode==4)*dTrnW2) +
                          ((timeCode==timeCode_val)*(amode==5)*wTrnD2)
                  )
  print(paste("For", timeCode, "assigned", prettyNum(sum(!is.na(trips$active2)),big.mark=","),
              "active times, with", prettyNum(sum(!is.na(trips$active2)&(trips$active2>0)),big.mark=","),
              "nonzero values"))
  trips$active2[is.na(trips$active2)] <- 0           # make the unassigned ones 0 for summing
  trips <- mutate(trips, active=active+active2)      # sum
  print(paste("  -> total nonzero active times:",prettyNum(sum(trips$active!=0),big.mark=",")))
  trips <- select(trips, -walk, -bike, -wTrnW, -dTrnW, -wTrnD, -walk2, -bike2, -wTrnW2, -dTrnW2, -wTrnD2, -active2) # rid new variables
}

# go go gadget: Add active transportation time to trips
trips <- init_active(trips)
for (timeCode_val in timeCode_values) {
  trips <- add_active(timeCode_val, trips)
}
trips <- tbl_df(trips)
```

# Formatting

## Make an xtable look nice
```{r xtablePretty}
# function make_pretty: pass in labels column and values column of an xtable.
# "Average" values will be decimals.
# "Share" values will be percentages.
# All others will be integers.
xtable_pretty <- function(labels, values) {
  for (rownum in 1:length(values)) {
    if (grepl("Share", labels[rownum])) { 
      values[rownum] <- sprintf("%.1f%%", 100.0*as.numeric(values[rownum]))
    }
    else {
      if (grepl("Average", labels[rownum])) {
        values[rownum] <- sprintf("%.2f", as.numeric(values[rownum]))
      }
      else {
        values[rownum] <- prettyNum(as.integer(values[rownum]), big.mark=",")
      }
    }
  }
  return(values)
}
```

# Active Transportation Summary
```{r ActiveTransportationSummary}
# we only want some variables - sum them to hh_id/person_id
trips_ats   <- select(trips, hh_id, person_id, wlk_trip, bik_trip, wtr_trip, dtr_trip, active)
trips_melt  <- tbl_df(melt(trips_ats, id.vars=c("hh_id","person_id")))
trips_dcast <- tbl_df(dcast(trips_melt, hh_id+person_id ~ variable, fun.aggregate=sum))
# left join with persons --> one row per person!
trips_by_person <- left_join(select(persons, hh_id, person_id, ptype, activity_pattern, value_of_time), 
                             trips_dcast, by=c("hh_id","person_id"))

# append autos, taz, COUNTY from households
trips_by_person <- left_join(trips_by_person, select(households, hh_id, autos, taz, COUNTY), by=c("hh_id"))
# recode zeroAuto
trips_by_person <- mutate(trips_by_person, 
                          zeroAuto=(autos==0),
                          atHomeA=is.na(active))
# set NAs to zero
trips_by_person$wlk_trip[is.na(trips_by_person$wlk_trip)] <- 0
trips_by_person$bik_trip[is.na(trips_by_person$bik_trip)] <- 0
trips_by_person$wtr_trip[is.na(trips_by_person$wtr_trip)] <- 0
trips_by_person$dtr_trip[is.na(trips_by_person$dtr_trip)] <- 0
trips_by_person$active[is.na(trips_by_person$active)] <- 0

trips_by_person <- mutate(trips_by_person, more15=(active>=15), more30=(active>=30))

# summarize
active_summary <- summarise(group_by(trips_by_person, taz, COUNTY, ptype, zeroAuto), 
                            freq     = n(),
                            active   = mean(active),
                            more15   = mean(more15),
                            more30   = mean(more30),
                            wlk_trip = mean(wlk_trip),
                            bik_trip = mean(bik_trip),
                            wtr_trip = mean(wtr_trip),
                            dtr_trip = mean(dtr_trip),
                            atHomeA  = mean(atHomeA))

write.table(active_summary, "summary/ActiveTransport.csv", sep=",", row.names=FALSE)
```

## Active Travel Summary - Overall
```{r ActiveTransportationSummary_overall, results='asis', echo=FALSE}
active_summary_all <- summarise(trips_by_person, 
                            freq     = n(),
                            atHomeA  = mean(atHomeA),
                            active   = mean(active),
                            more15   = mean(more15),
                            more30   = mean(more30),
                            wlk_trip = mean(wlk_trip),
                            bik_trip = mean(bik_trip),
                            wtr_trip = mean(wtr_trip),
                            dtr_trip = mean(dtr_trip)
                            )
# multiply the trip rates by the number of people to get number of trips
active_summary_all[,6:9] <- active_summary_all[,6:9]*active_summary_all[,1]
# combine walk-transit and drive-transit
active_summary_all[,8]   <- active_summary_all[,8]+active_summary_all[,9]
active_summary_all$dtr_trip <- NULL
# transpose it
active_summary_all <- tbl_df(as.data.frame(t(active_summary_all)))
active_summary_all$Category <- c("Regional","Regional",
                                 "Active travel","Active travel","Active travel",
                                 "Active travel","Active travel","Active travel")
active_summary_all$Measure  <- c("Population",
                                 "Share of population that does not leave home on a typical weekday",
                                 "Average minutes of active travel per person per typical weekday",
                                 "Share of the population that engages in at least 15 minutes of active travel per typical weekday",
                                 "Share of the population that engages in at least 30 minutes of active travel per typical weekday",
                                 "Total walk trips (excluding walking as part of transit travel",
                                 "Total bicycle trips",
                                 "Total walk trips which are part of transit travel")
# reorder columns
active_summary_all          <- active_summary_all[c("Category", "Measure", "V1")]
colnames(active_summary_all)[3] <- "Quantity"
ats_all_xtable              <- xtable(active_summary_all,
                                      caption="Active Travel - Regional Summary",
                                      align="lllr")
ats_all_xtable$Quantity     <- xtable_pretty(ats_all_xtable$Measure, ats_all_xtable$Quantity)
print(ats_all_xtable, type="html", include.rownames=FALSE)
```

## Active Travel Summary - By Person Type
```{r ActiveTransportationSummary_ptype, results='asis', echo=FALSE}
active_summary_ptype <- summarise(group_by(trips_by_person, ptype),
                            freq     = n(),
                            atHomeA  = mean(atHomeA),
                            active   = mean(active),
                            more15   = mean(more15),
                            more30   = mean(more30),
                            wlk_trip = mean(wlk_trip),
                            bik_trip = mean(bik_trip),
                            wtr_trip = mean(wtr_trip),
                            dtr_trip = mean(dtr_trip)
                            )
if (identical(as.numeric(active_summary_ptype$ptype), c(1,2,3,4,5,6,7,8))) {
  rownames(active_summary_ptype) <- ptype_labels
} else {
  rownames(active_summary_ptype) <- active_summary_ptype$ptype
}
active_summary_ptype$ptype <- NULL
# multiply the trip rates by the number of people to get number of trips
active_summary_ptype[,6:9] <- active_summary_ptype[,6:9]*active_summary_ptype[,1]
# combine walk-transit and drive-transit
active_summary_ptype[,8]   <- active_summary_ptype[,8]+active_summary_ptype[,9]
active_summary_ptype$dtr_trip   <- NULL

# transpose it to get ptypes across the top
active_summary_ptype       <- as.data.frame(t(active_summary_ptype))
# add label cols
active_summary_ptype$Category <- active_summary_all$Category
active_summary_ptype$Measure  <- active_summary_all$Measure
# reorder columns
active_summary_ptype          <- active_summary_ptype[append(c("Category", "Measure"), ptype_labels)]
ats_ptype_xtable              <- xtable(active_summary_ptype,
                                        caption="Active Travel - By Person Type",
                                        align="lllrrrrrrrr")
for (ptype_val in ptype_labels) {
  ats_ptype_xtable[[ptype_val]] <- xtable_pretty(ats_ptype_xtable$Measure, get(ptype_val, ats_ptype_xtable))
}
print(ats_all_xtable, type="html", include.rownames=FALSE)
```

## Active Travel Summary - By County of Residence
```{r ActiveTransportationSummary_county}

```

## Active Travel Summary - By Automobile Ownership
```{r ActiveTransportationSummary_zeroauto}
```

# Activity Pattern Summary
```{r ActivityPatternSummary}
actpatt_summary <- summarise(group_by(persons, type, activity_pattern, imf_choice, inmf_choice, incQ), freq=n())
write.table(actpatt_summary, "summary/ActivityPattern.csv", sep=",", row.names=FALSE)
```

# Activity Pattern Summary By Person Type
```{r ActivityPatternSummaryByPersonType}
aps_pp_table                     <- dcast(actpatt_summary, type ~ activity_pattern, value.var="freq")
```

# Auto Ownership Summaries
```{r AutoOwnershipSummary}
# summarise
autoown_summary <- summarise(group_by(households, SD, COUNTY, autos, incQ, walk_subzone, workers, kidsNoDr), freq=n())
write.table(autoown_summary, "summary/AutomobileOwnership.csv", sep=",", row.names=FALSE)
```

## Auto Ownership Summary By County
```{r AutoOwnershipSummaryByCountyGraph, fig.width=8, fig.height=5}
auto_labels <- c("Zero automobiles", "One automobile", "Two automobiles",
                 "Three automobiles", "Four or more automobiles")

# by County
autoown_summary_county <- summarise(group_by(autoown_summary, COUNTY, autos), freq=sum(freq))
ggplot(autoown_summary_county, aes(x=as.factor(COUNTY), y=freq, fill=as.factor(autos))) +
  geom_bar(stat="identity", position="fill") +
  scale_y_continuous(labels=percent, breaks=seq(0,1,0.1)) +
  scale_x_discrete(labels=county_labels) +
  xlab("County of Residence") + 
  ylab("Share of Households") +
  ggtitle("Households by Automobile Ownership and County of Residence") +
  scale_fill_discrete(name="", 
                      breaks=c(4,3,2,1,0), 
                      labels=rev(auto_labels))
```

```{r AutoOwnershipSummaryByCountyTable, results='asis', echo=FALSE}
aos_ac_table                     <- dcast(autoown_summary_county, autos ~ COUNTY, value.var="freq")
# make rownames readable

rownames(aos_ac_table)           <- auto_labels
aos_ac_table                     <- select(aos_ac_table, -autos)
# add Sum row and name it Everyone
aos_ac_table_summed              <- addmargins(as.table(as.matrix(aos_ac_table)), 1, FUN=sum)
rownames(aos_ac_table_summed)[6] <- "Everyone"
# name columns
colnames(aos_ac_table_summed)    <- county_labels
aos_ac_xtable                    <- xtable(apply(aos_ac_table_summed, 2, prettyNum, big.mark=","), 
                                         align="lrrrrrrrrr",
                                         caption="Automobile Ownership Levels by County")
print(aos_ac_xtable, type="html")


# shares
aos_ac_table_share              <- prop.table(as.table(as.matrix(aos_ac_table)),2)
aos_ac_table_share              <- addmargins(aos_ac_table_share, 1, FUN=sum)
rownames(aos_ac_table_share)[6] <- "Everyone"
colnames(aos_ac_table_share)    <- county_labels
aos_ac_xtable_share             <- xtable(apply(aos_ac_table_share, 2, function(u) sprintf("%.1f%%",u*100)),
                                        align="lrrrrrrrrr",
                                        caption="Automobile Ownership Share by County")
rownames(aos_ac_xtable_share)   <- append(auto_labels,"Everyone")
print(aos_ac_xtable_share, type="html")
```

## Auto Ownership Summary By Workers
```{r AutoOwnershipSummaryByWorkersGraph, fig.width=8, fig.height=5}
# by Workers
autoown_summary_workers <- summarise(group_by(autoown_summary, workers, autos), freq=sum(freq))

ggplot(autoown_summary_workers, aes(x=as.factor(workers), y=freq, fill=as.factor(autos))) +
  geom_bar(stat="identity", position="fill") +
  scale_y_continuous(labels=percent, breaks=seq(0,1,0.1)) +
  scale_x_discrete(labels=worker_labels) +
  xlab("Workers in the Household") + 
  ylab("Share of Households") +
  ggtitle("Households by Automobile Ownership and Number of Workers") +
  scale_fill_discrete(name="", 
                      breaks=c(4,3,2,1,0), 
                      labels=rev(auto_labels))
```

```{r AutoOwnershipSummaryByWorkersTable, results='asis', echo=FALSE}
aos_aw_table <- dcast(autoown_summary_workers, autos ~ workers, value.var="freq")
# make rownames readable
# stopifnot(aos_aw_table$autos == c(0,1,2,3,4))
rownames(aos_aw_table)           <- auto_labels
aos_aw_table                     <- select(aos_aw_table, -autos)
# add Sum row and name it Everyone
aos_aw_table_summed              <- addmargins(as.table(as.matrix(aos_aw_table)), 1, FUN=sum)
rownames(aos_aw_table_summed)[6] <- "Everyone"
# name columns
colnames(aos_aw_table_summed)    <- worker_labels
aosw_xtable                      <- xtable(apply(aos_aw_table_summed, 2, prettyNum, big.mark=","), 
                                           align="lrrrrr",
                                           caption="Automobile Ownership Levels by Number of Workers")
print(aosw_xtable, type="html")


# shares
aos_aw_table_share              <- prop.table(as.table(as.matrix(aos_aw_table)),2)
aos_aw_table_share              <- addmargins(aos_aw_table_share, 1, FUN=sum)
rownames(aos_aw_table_share)[6] <- "Everyone"
colnames(aos_aw_table_share)    <- worker_labels
aosw_xtable_share               <- xtable(apply(aos_aw_table_share, 2, function(u) sprintf("%.1f%%",u*100)),
                                          align="lrrrrr",
                                          caption="Automobile Ownership Share by Number of Workers")
rownames(aosw_xtable_share)     <- append(auto_labels,"Everyone")
print(aosw_xtable_share, type="html")
```

## Average Auto Ownership Summary By County and Transit Availability
```{r AutoOwnershipSummaryByCountyTrnAvailGraph, fig.width=8, fig.height=5}
# by Workers
autoown_summary_trncoutny <- summarise(group_by(autoown_summary, COUNTY, walk_subzone, autos), freq=sum(freq))
autoown_summary_trncoutny <- mutate(autoown_summary_trncoutny, totautos=autos*freq)
# ggplot(autoown_summary_workers, aes(x=as.factor(workers), y=freq, fill=as.factor(autos))) +
#  geom_bar(stat="identity", position="fill") +
#  scale_y_continuous(labels=percent, breaks=seq(0,1,0.1)) +
#  scale_x_discrete(labels=worker_labels) +
#  xlab("Workers in the Household") + 
#  ylab("Share of Households") +
#  ggtitle("Households by Automobile Ownership and Number of Workers") +
#  scale_fill_discrete(name="", 
#                      breaks=c(4,3,2,1,0), 
#                      labels=rev(auto_labels))
```

```{r AutoOwnershipSummaryByCountyTrnAvailTable, results='asis', echo=FALSE}
# households in walk_subzones x county
aos_wc_table                  <- dcast(autoown_summary_trncoutny, walk_subzone ~ COUNTY, 
                                       value.var="freq", fun.aggregate=sum)
# stopifnot(aos_wc_table$walk_subzone == c(0,1,2))
rownames(aos_wc_table)        <- walk_subzone_labels
aos_wc_table                  <- select(aos_wc_table, -walk_subzone)
aos_wc_table_summed           <- addmargins(as.table(as.matrix(aos_wc_table)), 1, FUN=sum)

# total autos in walk_subzones x county
aos_wc_table_totaut           <- dcast(autoown_summary_trncoutny, walk_subzone ~ COUNTY, 
                                       value.var="totautos", fun.aggregate=sum)
# stopifnot(aos_wc_table_totaut$walk_subzone == c(0,1,2))
rownames(aos_wc_table_totaut) <- walk_subzone_labels
aos_wc_table_totaut           <- select(aos_wc_table_totaut, -walk_subzone)
aos_wc_table_totaut_summed    <- addmargins(as.table(as.matrix(aos_wc_table_totaut)), 1, FUN=sum)

# avg autos in walk_subzones x county
aos_wc_table_avgaut           <- aos_wc_table_totaut_summed/aos_wc_table_summed
rownames(aos_wc_table_avgaut)[4] <- "Everyone"
colnames(aos_wc_table_avgaut) <- county_labels
aos_wc_xtable_avgaut          <- xtable(apply(aos_wc_table_avgaut, 2, function(u) sprintf("%.2f",u)), 
                                        align="lrrrrrrrrr",
                                        caption=paste("Average Automobile Ownership Levels",
                                                      "(capped at 4 per household) by County ",
                                                      "and Walk-to-Transit Accessibility"))
rownames(aos_wc_xtable_avgaut)<- append(walk_subzone_labels, "Everyone")
print(aos_wc_xtable_avgaut, type="html")

# number of households in walk_subzones x county
rownames(aos_wc_table_summed)[4] <- "Everyone"
colnames(aos_wc_table_summed) <- county_labels
aos_wc_xtable_summed          <- xtable(apply(aos_wc_table_summed, 2, prettyNum, big.mark=","), 
                                        align="lrrrrrrrrr",
                                        caption=paste("Number of households by County",
                                                      "and Walk-to-Transit Accessibility"))
rownames(aos_wc_xtable_summed)<- append(walk_subzone_labels, "Everyone")
print(aos_wc_xtable_summed, type="html")

```