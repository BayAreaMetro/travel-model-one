# -------------------------------------------------------------------------
# Analysis to inform the implementation of a "pseudo monthly toll cap" strategy
# Specifically, this script looks at different level of trip toll cap, to understand if we are offering too much toll cap to some
#
# input:   
# %TARGET_DIR%\updated_output\trips_with_detailed_cost.rdata
# (generated by travel-model-one/utilities/NextGenFwys/metrics/travel-cost-by-income-driving-households.r)
#
# -------------------------------------------------------------------------

library(dplyr)
library(knitr) # for the kable function that creates well-formatted tables 

# ------------------------------------------
# read inputs
# ------------------------------------------
# look at the scenario in Round 1: All Lane Tolling + Transit 
# it has Means_Based_Tolling_Q1Factor  = 1, so it's probably closest to what we'll have for Round 2
TARGET_DIR="//model3-a/Model3A-Share/Projects/2035_TM152_NGF_NP10_Path1a_02"

# another Round 1 scenario is: All Lane Tolling + Affordability Focus
# it has Means_Based_Tolling_Q1Factor  = 0.5 
# (note that in Round 2, in pathways where we have monthly toll cap, we won't have toll discount, so Path1a in Round 1 is a better choice for this analysis)
# TARGET_DIR="//MODEL3-B/Model3B-Share/Projects/2035_TM152_NGF_NP10_Path1b_02"

detailedCost_file <- file.path(TARGET_DIR, "updated_output", "trips_with_detailed_cost.rdata")
load(detailedCost_file)

# ------------------------------------------
# Preprocessing 
# ------------------------------------------

# The dataframe already has a name - it's trips
# Rename dataframe with a df_ prefix to make it easier to remember it is a data frame
df_tripCosts <- trips
rm(trips)

# Note that the input file trips_with_detailed_cost.rdata is a 50% sample
SAMPLESHARE  <- 0.5


#-----------------------------------------------
# Create a universe of just toll trips
#-----------------------------------------------
df_tolltripCosts <- df_tripCosts %>%
   filter(value_toll > 0)

# ------------------------------------------
# Test different levels of trip toll caps 
# Assuming the daily toll cap is 0.770 cents
# 0.77 dollars i.e. 1 x daily toll cap
# 0.385 dollars i.e. 0.5 x daily toll cap
# both of the above are in 2000$
# ------------------------------------------
DailyCap  <- 77.0

# Trip toll cap is X% of daily toll cap
TripTollCap_factor <- 0.3

df_tolltripCosts$vtoll_capAt100pcDC <- pmin(DailyCap,                    df_tolltripCosts$value_toll)
df_tolltripCosts$vtoll_capAt50pcDC  <- pmin(DailyCap*0.5,                df_tolltripCosts$value_toll)
df_tolltripCosts$vtoll_capAtXpcDC   <- pmin(DailyCap*TripTollCap_factor, df_tolltripCosts$value_toll)

#reorder
df_tolltripCosts <- df_tolltripCosts %>%
  select(person_id, value_toll, vtoll_capAt100pcDC, vtoll_capAt50pcDC, vtoll_capAtXpcDC, everything())

#-----------------------------------------------
# Convert data frame to person level
#-----------------------------------------------

df_personCosts <- df_tolltripCosts %>%
  group_by(person_id) %>%
  summarise(
    hhld_incQ               = first(incQ),
    hhld_incQ_label         = first(incQ_label),
    hhld_income             = first(income),
    hhld_autos              = first(autos),
    home_taz                = first(home_taz),
    hhld_travel             = first(hhld_travel),
    hhld_trips              = first(hhld_trips),
    hhld_auto_seg_trips     = first(hhld_auto_seg_trips),
    hhld_transit_seg_trips  = first(hhld_transit_seg_trips),
    person_numtrips         = n(),
    person_parking_cost     = sum(totalParkingCost, na.rm = TRUE),
    person_auto_op_cost     = sum(auto_op_cost, na.rm = TRUE),
    person_bridge_toll      = sum(bridge_toll, na.rm = TRUE),
    person_cordon_toll      = sum(cordon_toll, na.rm = TRUE),
    person_value_toll       = sum(value_toll, na.rm = TRUE),
    person_fare             = sum(fare, na.rm = TRUE),
    person_drv_trn_op_cost  = sum(drv_trn_op_cost, na.rm = TRUE),
    person_taxitnc_cost     = sum(taxitnc_cost, na.rm = TRUE),
    person_capAt100pcDC     = sum(vtoll_capAt100pcDC, na.rm = TRUE),
    person_capAt50pcDC      = sum(vtoll_capAt50pcDC, na.rm = TRUE),
    person_capAtXpcDC      = sum(vtoll_capAtXpcDC, na.rm = TRUE)
  )

# it takes a while to generate the person level file


#-----------------------------------------------
# Create new variables to see if the person go over the daily cap, pay the daily cap amount, or pay less than the daily cap amount
#-----------------------------------------------

# For example, I made 1 trip in the simulated day
# It costs 50 cents
# If the trip level toll cap is 35 cents
# And the the daily toll cap is 70 cents
# With the trip level toll cap implementation, I only have to pay 35 cents for my trip
# This would be the trip level toll cap abstraction gives me 50-35 cents savings that I'm not supposed to get under a real daily toll cap implementation scenario
# this is the case when my person_value_toll is > the capped amount resulting from the trip toll cap, but smaller than the daily toll cap


df_personCosts <- df_personCosts %>%
  mutate(
    PersonVtollMinusVtollCappedAt100pcDC = person_value_toll - person_capAt100pcDC,
    PersonVtollMinusVtollCappedAt50pcDC = person_value_toll - person_capAt50pcDC,
    PersonVtollMinusVtollCappedAtXpcDC = person_value_toll - person_capAtXpcDC
  )
# the diff will be always greater than 0 because the cap should always results in savings to users 

# also want to quantify the diff between the Daily Cap and the amount paid with the trip toll cap
# essentially this shows the diff between an implmentation of a true daily cap vs the pseudo daily cap (aka the trip toll cap)
df_personCosts <- df_personCosts %>%
  mutate(
    DailyCapMinusVtollCappedAt100pcDC = DailyCap - person_capAt100pcDC,
    DailyCapMinusVtollCappedAt50pcDC =  DailyCap - person_capAt50pcDC,
    DailyCapMinusVtollCappedAtXpcDC = DailyCap - person_capAtXpcDC
  )

# also need to know the number of users who wouldn't go over the limits anyway
# Look at the "base line distribution" of person_value_toll vs DailyCap 
df_personCosts <- df_personCosts %>%
  mutate(vtollGroups_ifNoCap = case_when(
   person_value_toll <= DailyCap  ~ "A. Light toll road users who would not have gone over the daily cap anyway",
   person_value_toll > DailyCap   ~ " B. Heavy toll road users who would've gone over if there is no daily cap"
  ))

df_freqTable_ifNoCap <- df_personCosts %>%
  group_by(vtollGroups_ifNoCap) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)
kable(df_freqTable_ifNoCap, caption = "Number of toll road users who would not go over the cap anyway", format = "markdown")


# put the toll road users into 4 groups
df_personCosts <- df_personCosts %>%
  mutate(vtollGroups_capAt100pcDC = case_when(
    person_value_toll <= DailyCap                                       ~ "1. Light users who would not have gone over the daily cap anyway",
    (person_value_toll > DailyCap) & (person_capAt100pcDC < DailyCap)   ~ "2. Capped in effect; users pay less than the daily cap",
    (person_value_toll > DailyCap) & (person_capAt100pcDC == DailyCap)  ~ "3. Capped in effect; users pay exactly the daily cap",
    (person_value_toll > DailyCap) & (person_capAt100pcDC > DailyCap)   ~ "4. Cap reduces their toll costs, but they still go over"
  ))

df_personCosts <- df_personCosts %>%
  mutate(vtollGroups_capAt50pcDC = case_when(
    person_value_toll <= DailyCap                                       ~ "1. Light users who would not have gone over the daily cap anyway",
    (person_value_toll > DailyCap) & (person_capAt50pcDC < DailyCap)   ~ "2. Capped in effect; users pay less than the daily cap",
    (person_value_toll > DailyCap) & (person_capAt50pcDC == DailyCap)  ~ "3. Capped in effect; users pay exactly the daily cap",
    (person_value_toll > DailyCap) & (person_capAt50pcDC > DailyCap)   ~ "4. Cap reduces their toll costs, but they still go over"
  ))

df_personCosts <- df_personCosts %>%
  mutate(vtollGroups_capAtXpcDC = case_when(
    person_value_toll <= DailyCap                                     ~ "1. Light users who would not have gone over the daily cap anyway",
    (person_value_toll > DailyCap) & (person_capAtXpcDC < DailyCap)   ~ "2. Capped in effect; users pay less than the daily cap",
    (person_value_toll > DailyCap) & (person_capAtXpcDC == DailyCap)  ~ "3. Capped in effect; users pay exactly the daily cap",
    (person_value_toll > DailyCap) & (person_capAtXpcDC > DailyCap)   ~ "4. Cap reduces their toll costs, but they still go over"
  ))

df_freqTable_capAt100pcDC <- df_personCosts %>%
  group_by(vtollGroups_capAt100pcDC) %>%
  summarise(
    countOfusers = n(),
    Diff_GenuineVsPseudo = sum(DailyCapMinusVtollCappedAt100pcDC),
    Savings_2000cents = sum(PersonVtollMinusVtollCappedAt100pcDC)
  ) %>%
  mutate(
   percentageOfusers = countOfusers / sum(countOfusers) * 100
  )

# reorder the columns
df_freqTable_capAt100pcDC <- df_freqTable_capAt100pcDC %>%
  select(vtollGroups_capAt100pcDC,countOfusers, percentageOfusers, Savings_2000cents, Diff_GenuineVsPseudo)

kable(df_freqTable_capAt100pcDC, caption = "Look at how many people go over the daily cap, pay the daily cap amount, or pay less than the daily cap amount, when the trip level cap = 100% of the daily cap", format = "markdown")

df_freqTable_capAt50pcDC <- df_personCosts %>%
  group_by(vtollGroups_capAt50pcDC) %>%
  summarise(
    countOfusers = n(),
    Diff_GenuineVsPseudo = sum(DailyCapMinusVtollCappedAt50pcDC),
    Savings_2000cents = sum(PersonVtollMinusVtollCappedAt50pcDC)
  ) %>%
  mutate(
   percentageOfusers = countOfusers / sum(countOfusers) * 100
  )

# reorder the columns
df_freqTable_capAt50pcDC <- df_freqTable_capAt50pcDC %>%
  select(vtollGroups_capAt50pcDC,countOfusers, percentageOfusers, Savings_2000cents, Diff_GenuineVsPseudo)

kable(df_freqTable_capAt50pcDC, caption = "Look at how many people go over the daily cap, pay the daily cap amount, or pay less than the daily cap amount, when the trip level cap = 50% of the daily cap", format = "markdown")

df_freqTable_capAtXpcDC <- df_personCosts %>%
  group_by(vtollGroups_capAtXpcDC) %>%
  summarise(
    countOfusers = n(),
    Diff_GenuineVsPseudo = sum(DailyCapMinusVtollCappedAtXpcDC),
    Savings_2000cents = sum(PersonVtollMinusVtollCappedAtXpcDC)
  ) %>%
  mutate(
   percentageOfusers = countOfusers / sum(countOfusers) * 100
  )

# reorder the columns
df_freqTable_capAtXpcDC <- df_freqTable_capAtXpcDC %>%
  select(vtollGroups_capAtXpcDC,countOfusers, percentageOfusers, Savings_2000cents, Diff_GenuineVsPseudo)

kable(df_freqTable_capAtXpcDC, caption = "Look at how many people go over the daily cap, pay the daily cap amount, or pay less than the daily cap amount, when the trip level cap = X% of the daily cap", format = "markdown")



#-----------------------------------------------
# I think we need to think through what we want to optimize for
# e.g. Solve X to maximize the number of people paying exactly the cap amount
# or, Solve X to minimize the number of people benefiting too much from the cap
# or something else?
#-----------------------------------------------